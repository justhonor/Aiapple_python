<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 捉虫动态 · BUG 几例</title>
  <meta name="description" content="随着RDS MySQL用户越来越多，隐藏很久很深的bug也逐渐被挖出来了，下面分享一下最近遇到的三例bug，都是官方版本存在的。trigger/function中drop temporary table导致slave中断只有5.6受到影响。复现步骤打开gtid_mode=ONcreate function `te...">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2015/09/03/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2015/09">
    <h1>数据库内核月报 － 2015 / 09</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2015/09/02/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2015/09/04/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/01/" target="_blank">
                
                MySQL · 引擎特性 ·  InnoDB Adaptive hash index介绍
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/02/" target="_blank">
                
                PgSQL · 特性分析 ·  clog异步提交一致性、原子操作与fsync
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2015/09/03/" target="_blank">
                
                MySQL · 捉虫动态 · BUG 几例
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/04/" target="_blank">
                
                PgSQL · 答疑解惑 · 诡异的函数返回值
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/05/" target="_blank">
                
                MySQL · 捉虫动态 · 建表过程中crash造成重建表失败
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/06/" target="_blank">
                
                PgSQL · 特性分析 · 谈谈checkpoint的调度
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/07/" target="_blank">
                
                MySQL · 特性分析 · 5.6 并行复制恢复实现
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/08/" target="_blank">
                
                MySQL · 备库优化 ·  relay fetch 备库优化
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/09/" target="_blank">
                
                MySQL · 特性分析 · 5.6并行复制事件分发机制
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/10/" target="_blank">
                
                MySQL · TokuDB · 文件目录谈
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 捉虫动态 · BUG 几例
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <p>随着RDS MySQL用户越来越多，隐藏很久很深的bug也逐渐被挖出来了，下面分享一下最近遇到的三例bug，都是官方版本存在的。</p>

<h2>trigger/function中drop temporary table导致slave中断</h2>

<p>只有5.6受到影响。</p>

<p><strong>复现步骤</strong></p>

<pre><code class="language-SQL">打开gtid_mode=ON

create function `test_func_1` () returns varchar(30) charset utf8
begin
    drop temporary table if exists test_func_1;
    drop temporary table if exists test_func_2;
    return "hello";
end;

select test_func_1();
</code></pre>

<p><strong>原因分析</strong></p>

<p>function/trigger和procedure不同，不能单独执行，必须依赖statement才能存在，这样就决定了 function/trigger 的事务边界必须由statement来定义，所以<code>create function/trigger</code>的时候，会进行检测body中是否有事务边界定义。比如，如果有commit/rollback，或者会引起隐式提交的DDL语句，那么就会报以下错误：</p>

<pre><code>1422 - Explicit or implicit commit is not allowed in stored function or trigger.
</code></pre>

<p><strong>MySQL 5.5为什么会成功？</strong><br />
因为<code>drop temporary table</code>是一个比较特殊的语句，虽然是DDL语句，但不会隐式提交，所以进行了特殊处理，可以使用。</p>

<p><strong>MySQL 5.6 为什么主库会成功，备库会失败呢？</strong><br />
在打开gtid_mode的情况下，gtid有一个特殊的限制，不能在事务的过程中进行<code>drop temporary table</code>。如果要使用，必须为<code>drop temporary table</code>独立分配一个GTID。</p>

<p>复现方法中的function在主库执行的时候，产生的binlog event如下：</p>

<pre><code>| master-bin.000001 |  580 | Gtid           |         1 |         628 | SET @@SESSION.GTID_NEXT= 'cfef3544-1327-11e5-8a6f-2c44fd7a5210:2'                                                                                                                                                                                                                                               |
| master-bin.000001 |  628 | Query          |         1 |         779 | DROP TEMPORARY TABLE IF EXISTS `test`.`test_func_1` /* generated by server */                                                                                                                                                                                                                                   |
| master-bin.000001 |  779 | Query          |         1 |         930 | DROP TEMPORARY TABLE IF EXISTS `test`.`test_func_2` /* generated by server */                                                                                                                                                                                                                                   |
</code></pre>

<p>而这样的event在备库slave线程执行的时候，不满足gtid对于<code>drop temproary table</code>的要求，所以报错。</p>

<p><strong>修复方法</strong><br />
既然gtid_mode=on的时候，<code>drop temproary table</code>必须要分配一个gtid，那么也就意味着它虽然不会隐式提交，但还是定义了事务边界。修复方法就是就在<code>gtid_pre_statement_checks</code>的时候，对于这样的情况就拒绝执行。</p>

<h2>drop带有中文表名的语句在备库执行失败</h2>

<p>5.1、5.5、5.6都受影响。</p>

<p><strong>复现步骤</strong></p>

<pre><code>use test;
set names gbk;
create table test.`t_测试_table`(id int);
drop table test.`t_测试_table`;
</code></pre>

<p><strong>原因分析</strong><br />
首先环境设置:</p>

<pre><code>set names gbk;
create table test.`t_测试_table`(id int);
</code></pre>

<p>牵涉到的字符集如下:</p>

<pre><code class="language-sql">session环境:     gbk
query串:          gbk
表名和文件名:     system_charset
query_event:     gdk

drop table test.`t_测试_table`：
session环境:     gbk
query串:     gbk
表名和文件名:     system_charset
query_event:     system_charset
</code></pre>

<p>因为<code>drop table</code>的query event是/* generated by server */，在主库生成的时候使用的字符集为system_charset，而在备库执行的时候，需要初始化session环境为主库带过来是gbk，而event本身是system_charset的，导致event和session环境的charset不一致，无法找到表而slave中断。</p>

<p><strong>修复方法</strong><br />
对于/* generated by server */的event，不沿用session的字符集，而是使用主库产生event时用的字符集。</p>

<h2>带有auto_increment字段的表转成archive引擎报错</h2>

<p>5.1、5.5、5.6都受影响。</p>

<p><strong>复现步骤</strong></p>

<pre><code>create table test.t(id int primary key auto_increment, col1 int) engine=innodb;
insert into test.t values(1, 2);
insert into test.t values(2, 2);
commit;

alter table test.t engine= archive;

ERROR 1022 (23000): Can't write; duplicate key in table '#sql-db11_2bfaa
</code></pre>

<p><strong>原因分析</strong><br />
archive是一个归档引擎，在写入的时候，必须按照递增顺序，也就是不能写入一个比当前pk小的记录，引擎层做了硬编码限制:</p>

<pre><code>/*
We don't support decremening auto_increment. They make the performance
just cry.
*/
if (temp_auto &lt;= share-&gt;archive_write.auto_increment &amp;&amp;
    mkey-&gt;flags &amp; HA_NOSAME)
{
  rc= HA_ERR_FOUND_DUPP_KEY;
  goto error;
}
</code></pre>

<p>而alter的过程中，因为没有指定<code>auto_increment</code>的值，所以<code>auto_increment</code>会从原表中继承过来，也就是等于2，而在copy数据的时候，先插入pk=1的记录，发现比当前<code>auto_increment</code>值小，就报了上面的错误。</p>

<p><strong>修复方法</strong></p>

<p>语句<code>alter table t engine=archive</code>，在转换成archive引擎的时候，如果没有指定<code>auto_increment</code>的值的时候，系统默认指定成0， 而不是沿用原表的当前<code>auto_increment</code>值。</p>

    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
