<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 特性分析 · 直方图的实现与分析</title>
  <meta name="description" content="直方图（Histogram）是 RDBMS 中提供的一种基础的统计信息，最典型的用途是估计查询谓词的选择率，以便选择优化的查询执行计划。常见的直方图种类有：等宽直方图、等高直方图、V-优化的直方图，MaxDiff 直方图等等。RDBMS 产品最初使用的直方图非常简单（只有一个桶），后来逐步演化到等宽直方图、等高直...">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2016/10/09/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2016/10">
    <h1>数据库内核月报 － 2016 / 10</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2016/10/08/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2016/10/10/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/01/" target="_blank">
                
                AliSQL · 社区动态 · 关于开源之后评论的评论
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/02/" target="_blank">
                
                MySQL · 社区见闻 · Oracle Open World 2016 见闻
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/03/" target="_blank">
                
                MySQL · 社区见闻 · Percona Live 2016 见闻
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/04/" target="_blank">
                
                MySQL · 社区见闻 · MariaDB Developer Meeting 2016
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/05/" target="_blank">
                
                MySQL · myrocks · data dictionary 分析
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/06/" target="_blank">
                
                MySQL · 源码分析 · 无法revoke单库或单表权限
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/07/" target="_blank">
                
                PgSQL · 代码浅析 · PostgreSQL 可靠性分析
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/08/" target="_blank">
                
                PgSQL · 代码浅析 · PostgreSQL 9.6 聚合OP复用的优化分析
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2016/10/09/" target="_blank">
                
                MySQL · 特性分析 · 直方图的实现与分析
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/10/10/" target="_blank">
                
                SQL Server · 最佳实践 · 参数嗅探问题
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 特性分析 · 直方图的实现与分析
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <p>直方图（Histogram）是 RDBMS 中提供的一种基础的统计信息，最典型的用途是估计查询谓词的选择率，以便选择优化的查询执行计划。常见的直方图种类有：等宽直方图、等高直方图、V-优化的直方图，MaxDiff 直方图等等。RDBMS 产品最初使用的直方图非常简单（只有一个桶），后来逐步演化到等宽直方图、等高直方图等。MariaDB 10.0.2 就已在 server 层实现了直方图功能，参考<a href="https://jira.mariadb.org/browse/MDEV-4145" title="Take into account the selectivity">Take into account the selectivity</a> 和 <a href="https://mariadb.com/kb/en/mariadb/histogram-based-statistics" title="Histogram based statistics">Histogram based statistics</a>。MySQL 在8.0.0 中也引入了直方图，参考<a href="https://dev.mysql.com/worklog/task/?id=8706" title="WL#8706: Persistent storage of Histogram data">WL#8706</a>和<a href="https://dev.mysql.com/worklog/task/?id=8707" title="WL#8707: Classes/structures for Histograms">WL8707</a>。</p>

<h2>MySQL 直方图的功能</h2>

<p>直方图会持久化存储到一个新的系统表 mysql.column_stats，表名与 MariaDB 的一样，但是定义是不同的。直方图的主要数据保存在一个 JSON 类型的名为 histogram 的列中。因为 8.0 的字典表都采用了 InnoDB 引擎，这个表也不例外。<br />
该特性支持所有的数据类型，包括数值类型、字符串、大对象、枚举类型等，也支持 GENERATED COLUMN。</p>

<p>MySQL 支持两种类型的直方图，第一种是等宽直方图的一种特殊情况，每个桶只有一个值，因此只需要保存该值和累积的频率。另一种是等高直方图，每个桶需要保存下界、上界、累积频率以及不同值的个数（Number of Distinct Value，NDV）。这两种直方图与 Oracle 的是类似的，见Histograms <a href="http://allthingsoracle.com/histograms-part-1-why/" title="Histograms Part 1">Part 1</a>/<a href="http://allthingsoracle.com/histograms-pt-2/" title="Histograms Part 2">Part 2</a>/<a href="http://allthingsoracle.com/histograms-part-3-when/" title="Histograms Part 3">Part 3</a>。</p>

<p>执行 ANALYZE TABLE [table] UPDATE HISTOGRAMS 命令可以产生表上各列的直方图，默认情况下这些信息会被复制到备库。</p>

<p>在文件 scripts/mysql_systemtables.sql 中可以看到该表的定义：</p>

<pre><code>--
-- Column statistics
--

CREATE TABLE IF NOT EXISTS column_stats (
  database_name VARCHAR(64) NOT NULL,
  table_name VARCHAR(64) NOT NULL,
  column_name VARCHAR(64) NOT NULL,
  histogram JSON NOT NULL,
  PRIMARY KEY (database_name, table_name, column_name)
) ENGINE=InnoDB CHARACTER SET=utf8 COLLATE=utf8_bin
COMMENT="Column statistics";
</code></pre>

<p>下面是这两种直方图的示例。</p>

<pre><code>Equi-height JSON definition
---------------------------

{
  // Last time the histogram was updated. As of now, this means "when the
  // histogram was created" (incremental updates are not supported). Date/time
  // is given in UTC.
  // -- J_DATETIME
  "last-updated": "2015-11-04 15:19:51.000000",

  // Histogram type. Always "equi-height" for equi-height histograms.
  // -- J_STRING
  "histogram-type": "equi-height",

  // Histogram buckets. This will always be at least one bucket.
  // -- J_ARRAY
  "buckets":
  [
    [
      // Lower inclusive value.
      // -- Data type depends on the source column.
      "0",

      // Upper inclusive value.
      // -- Data type depends on the source column.
      "002a38227ecc7f0d952e85ffe37832d3f58910da",

      // Cumulative frequence
      // -- J_DOUBLE
      0.001978728666831561,

      // Number of distinct values in this bucket.
      // -- J_UINT
      10
    ]
  ]
}

Singleton JSON definition
-------------------------

{
  // Last time the histogram was updated. As of now, this means "when the
  // histogram was created" (incremental updates are not supported). Date/time
  // is given in UTC.
  // -- J_DATETIME
  "last-updated": "2015-11-04 15:19:51.000000",

  // Histogram type. Always "singleton" for singleton histograms.
  // -- J_STRING
  "histogram-type": "singleton",

  // Histogram buckets. This will always be at least one bucket.
  // -- J_ARRAY
  "buckets":
  [
    [
      // Value value.
      // -- Data type depends on the source column.
      42,

      // Cumulative frequence
      // -- J_DOUBLE
      0.001978728666831561,
    ]
  ]
}
</code></pre>

<h2>MySQL 直方图的实现</h2>

<p>MySQL 8.0 的代码做过不少重整，目录结构也比以前清楚多了。直方图的源代码都在目录sql/histograms 下，包括以下文件。</p>

<ul>
  <li>equi_height_bucket.cc</li>
  <li>equi_height_bucket.h</li>
  <li>equi_height.cc</li>
  <li>equi_height.h</li>
  <li>histogram.cc</li>
  <li>histogram.h</li>
  <li>singleton.cc</li>
  <li>singleton.h</li>
</ul>

<p>对应的单元测试文件为：unittest/gunit/histograms-t.cc。可以看到，代码用到了 C++11 的一些特性，并且还写了比较完整的单元测试，可读性很好。代码主要部分是这三个类：直方图的基类 Histogram，以及实现等宽直方图、等高直方图的两个类 Singleton 和 Equi_height。</p>

<p>对外的主要接口是创建直方图的函数：</p>

<pre><code>template &lt;class T&gt;
Histogram *build_histogram(MEM_ROOT *mem_root,
                           const value_map_type&lt;T&gt; &amp;value_map,
                           ha_rows num_null_values, size_t num_buckets,
                           std::string db_name, std::string tbl_name,
                           std::string col_name)
</code></pre>

<p>输入的数据需要放到一个 map 里头，表示每个值以及对应的出现次数，map 是按照值排序的。直方图一般不会对表中的所有数据逐行进行分析建立，这样做的代价太高了；很多实现都是通过对数据采样进行的。因此，这里用 map 而不是 iterator 也是比较自然的。如果桶的个数（num_buckets）比不同值的个数要大，则自动选择创建一个等宽直方图；否则创建一个等高直方图。</p>

<pre><code>/*
  If the number of buckets specified is greater or equal to the number
  of distinct values, we create a Singleton histogram. Otherwise we create
  an equi-height histogram.
*/
 if (num_buckets &gt;= value_map.size())
 {
   Singleton&lt;T&gt; *singleton=
     new(mem_root) Singleton&lt;T&gt;(mem_root, db_name, tbl_name, col_name);
..
   if (singleton-&gt;build_histogram(value_map, num_null_values))
     return nullptr;                         /* purecov: inspected */
..
 }
 else
 {
   Equi_height&lt;T&gt; *equi_height=
     new(mem_root) Equi_height&lt;T&gt;(mem_root, db_name, tbl_name, col_name);
..
</code></pre>

<p>两种直方图的创建逻辑都比较简单，可以参看：<br />
Singleton&lt;T&gt;::build~histogram~() 和 Equi~height~&lt;T&gt;::build~histogram~()。</p>

<h2>总结</h2>

<p>通过参考资料中的内容，与 Oracle、MariaDB 做个对比，很容易发现 MySQL 8.0 目前实现的直方图还只是提供了最基础的功能，还不能用来改进查询执行计划。</p>

<h2>Footnotes</h2>

<ol>
  <li><a href="https://jira.mariadb.org/browse/MDEV-4145" title="Take into account the selectivity">Take into account the selectivity</a></li>
  <li><a href="https://mariadb.com/kb/en/mariadb/histogram-based-statistics" title="Histogram based statistics">Histogram based statistics</a></li>
  <li><a href="https://dev.mysql.com/worklog/task/?id=8706" title="WL#8706: Persistent storage of Histogram data">WL#8706: Persistent storage of Histogram data</a></li>
  <li><a href="https://dev.mysql.com/worklog/task/?id=8707" title="WL#8707: Classes/structures for Histograms">WL#8707: Classes/structures for Histograms</a></li>
  <li><a href="http://allthingsoracle.com/histograms-part-1-why/" title="Histograms Part 1">Histograms Part 1</a></li>
  <li><a href="http://allthingsoracle.com/histograms-pt-2/" title="Histograms Part 2">Histograms Part 2</a></li>
  <li><a href="http://allthingsoracle.com/histograms-part-3-when/" title="Histograms Part 3">Histograms Part 3</a></li>
</ol>


    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
