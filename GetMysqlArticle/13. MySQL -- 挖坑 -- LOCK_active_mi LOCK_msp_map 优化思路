<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 挖坑 · LOCK_active_mi/LOCK_msp_map 优化思路</title>
  <meta name="description" content="背景">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2017/02/03/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2017/02">
    <h1>数据库内核月报 － 2017 / 02</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2017/02/02/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2017/02/04/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/01/" target="_blank">
                
                AliSQL · 开源 · Sequence Engine
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/02/" target="_blank">
                
                MySQL · myrocks · myrocks之备份恢复
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2017/02/03/" target="_blank">
                
                MySQL · 挖坑 · LOCK_active_mi/LOCK_msp_map 优化思路
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/04/" target="_blank">
                
                MySQL · 源码分析 · 词法分析及其性能优化
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/05/" target="_blank">
                
                SQL优化 · 经典案例 · 索引篇
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/06/" target="_blank">
                
                MySQL · 新特性分析 · CTE执行过程与实现原理
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/07/" target="_blank">
                
                PgSQL · 源码分析 · PG优化器物理查询优化
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/08/" target="_blank">
                
                SQL Server · 特性介绍 · 聚集列存储索引
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/09/" target="_blank">
                
                PgSQL · 应用案例 · 聚集存储 与 BRIN索引
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2017/02/10/" target="_blank">
                
                PgSQL · 应用案例 · GIN索引在任意组合查询中的应用
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 挖坑 · LOCK_active_mi/LOCK_msp_map 优化思路
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <h2>背景</h2>

<p>在MySQL中Slave相关操作一直存在一把大锁——LOCK_active_mi (5.5及之前版本，以及MariaDB)，或LOCK_msp_map（5.6及之后的版本）。<br />
在Slave操作中大家可能经常会遇到如下懵逼的操作：</p>

<ol>
  <li>线程1：STOP SLAVE；有事务要回滚，一直不结束，然后LOCK_active_mi一直被这个线程持有</li>
  <li>线程2：SHOW SLAVE STATUS；拿不到LOCK_active_mi，无法执行。</li>
</ol>

<p>SHOW SLAVE STATUS 经常作为监控脚本的语句被自动执行，然后就不停地被卡住，线程堆积，直到 too many connections。</p>

<p>等到了5.6引入了多源复制之后，这个问题就更严重了，LOCK_msr_map需要在访问任何通道时都被持有，因此操作两个不同的通道也可能冲突。</p>

<p>Percona曾经推出了SHOW SLAVE STATUS NO_BLOCK这样的语法，不加锁查看复制状态，但是，毕竟这不是根治之法，一方面查看的数据并不一定对，还可能Crash（例如查看过程中通道被删除了），并且需要专门的语法。</p>

<p>特别是5.6还支持了多线程复制，IO THREAD可以多个（多通道），SQL THREAD可以并行（并行复制），这种情况下，LOCK_msr_map这么大一把锁就更加显得格格不入了。</p>

<h2>解决思路</h2>

<p>我们先来分析一下，对各个Slave通道的操作到底有哪些是真的互斥。</p>

<ol>
  <li>
    <p>并发读写同一个通道的运行状态：<br />
例如 mi-&gt;running，mi-&gt;info_thd 等，已有mi-&gt;run_lock保护IO线程，mi-&gt;rli-&gt;run_lock保护SQL线程。</p>
  </li>
  <li>
    <p>并发读写同一个通道的执行数据：<br />
例如 mi-&gt;master_log_pos，mi-&gt;rpl_filter 等，已有mi-&gt;data_lock保护IO线程，mi-&gt;rli-&gt;data_lock保护SQL线程。</p>
  </li>
  <li>
    <p>并发读写同一个通道的错误码和错误消息：<br />
例如 mi-&gt;last_error 等，已有mi-&gt;err_lock保护IO线程，mi-&gt;rli-&gt;err_lock保护SQL线程。</p>
  </li>
  <li>
    <p>对于多源复制，增减通道：<br />
msr_map结构的增删改查需要保护，否则可能在遍历所有通道时有通道增加或删除，那遍历结果就不对了。这里真的需要LOCK_msr_map保护。</p>
  </li>
</ol>

<p>可见，除了msr_map的操作真的需要全局互斥以外，其他的操作其实都有Master_info内的锁可以保护，在mi内部解决矛盾就可以，根本无需全局锁。</p>

<p>MySQL 5.7 给了一个改进方案，是将LOCK_msr_map从mysql_mutex_t（pthread_mutex_t）改成了Checkable_rwlock。这个方案可以解决部分只读操作时可以相互并发，但是并没有解决LOCK_msr_map保护范围太广的问题。上面我们给出的STOP SLAVE卡住（wr_lock）和SHOW SLAVE STATUS执行互斥的问题就没有解决。</p>

<p>为了彻底解决这个问题，我们可以参考InnoDB怎么保证Buffer Pool中Page的并发性的：</p>

<ol>
  <li>每当有线程正在访问Page时，将计数器（bpage-&gt;io_fix）加一，就把这个Page Pin在内存中了。</li>
  <li>LRU淘汰Page时，看到io_fix还不是0，就不能从内存中清理，因为还有人在访问，必须等到0才能清除。</li>
  <li>对Page内容的操作，有Latch来保证，避免同时有人修改页面。</li>
</ol>

<p>因此我们也可以在每个Master_info中加一个计数器（mi-&gt;users），有线程要使用mi，就将计数器加一，不用了就减一，以此来代替加锁放锁，再用一个专门的锁（sleep_lock）来保护计数器就可以了。</p>

<p>加锁操作成了：</p>

<pre><code>void Master_info::use()
{
  mysql_mutex_lock(&amp;sleep_lock);
  users++;
  mysql_mutex_unlock(&amp;sleep_lock);
}
</code></pre>

<p>放锁操作成了：</p>

<pre><code>void Master_info::release()
{
  mysql_mutex_lock(&amp;sleep_lock);
  if (!--users &amp;&amp; killed)
    mysql_cond_signal(&amp;sleep_cond);
  mysql_mutex_unlock(&amp;sleep_lock);
  DBUG_VOID_RETURN;

}
</code></pre>

<p>每次放锁时发一个信号量，让remove_mi操作能收到信号量后再执行删除Master_info的操作。</p>

<p>然后原本需要LOCK_msr_map保护的Master_info操作，可以缩小范围，只需要在取出mi时拿锁就可以了。</p>

<pre><code>Master_info *get_master_info(const char *connection_name)
{
  Master_info *mi;
  DBUG_ENTER("get_master_info");
  /* Protect against inserts into msr_map */
  mysql_mutex_lock(&amp;LOCK_msr_map);
  if ((mi= msr_map.get_mi(connection_name)))

    mi-&gt;use();
  mysql_mutex_unlock(&amp;LOCK_msr_map);
  DBUG_RETURN(mi);
}
</code></pre>

<p>再把原来需要get_mi调用的地方，全部修改为get_master_info这个调用，就可以删掉其mysql_mutex_lock(&amp;LOCK_msr_map)加锁保护了，放锁的mysql_mutex_unlock(&amp;LOCK_msr_map)语句全部改成mi-&gt;release()即可。这样就不存在全局锁定了。</p>

<p>比如启动一个通道的复制：</p>

<pre><code>if ((mi= get_master_info(lex-&gt;mi.channel)))
  {    
    res= start_slave(thd, mi, 1 /*net report */); 
    mi-&gt;release();
}
</code></pre>
<p>完全不需要 mysql_mutex_lock(&amp;LOCK_msr_map)和mysql_mutex_unlock(&amp;LOCK_msr_map)来包住start_slave了对不对！</p>

<p>但这种修改就带来了另一个问题，要删除一个Master_info的时候，可能还有线程在使用这个mi。<br />
因此在析构函数中需要增加一个等待，让这个mi的所有调用都释放了再清理这个mi。<br />
有了计数器这个也很容易做到，每当收到计数器减一的信号时，看一下是不是计数器到0了，到0了就说明所有使用者全部释放了，就可以正常删除了。</p>

<pre><code>void Master_info::wait_until_free()
{
  mysql_mutex_lock(&amp;sleep_lock);
  killed= 1;
  while (users)
    mysql_cond_wait(&amp;sleep_cond, &amp;sleep_lock);
  mysql_mutex_unlock(&amp;sleep_lock);
}
</code></pre>

<h2>效果</h2>

<p>这样改进以后，我们再来看最开始这个典型的案例：</p>

<ol>
  <li>STOP SLAVE执行卡住，那么会导致这个mi或者所有mi的计数器加一。</li>
  <li>SHOW SLAVE STATUS执行，在这个mi或者所有mi的计数器加一。<br />
并不涉及到相互锁定，只是此时无法删除通道而已，这也是合理的。两个线程都能愉快的执行自己的任务。</li>
</ol>

<p>补丁我们会在之后的AliSQL开源版本中开源，敬请期待。</p>


    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
