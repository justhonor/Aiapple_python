<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 特性分析 · 5.6并行复制事件分发机制</title>
  <meta name="description" content="并行复制相关线程">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2015/09/09/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2015/09">
    <h1>数据库内核月报 － 2015 / 09</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2015/09/08/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2015/09/10/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/01/" target="_blank">
                
                MySQL · 引擎特性 ·  InnoDB Adaptive hash index介绍
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/02/" target="_blank">
                
                PgSQL · 特性分析 ·  clog异步提交一致性、原子操作与fsync
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/03/" target="_blank">
                
                MySQL · 捉虫动态 · BUG 几例
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/04/" target="_blank">
                
                PgSQL · 答疑解惑 · 诡异的函数返回值
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/05/" target="_blank">
                
                MySQL · 捉虫动态 · 建表过程中crash造成重建表失败
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/06/" target="_blank">
                
                PgSQL · 特性分析 · 谈谈checkpoint的调度
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/07/" target="_blank">
                
                MySQL · 特性分析 · 5.6 并行复制恢复实现
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/08/" target="_blank">
                
                MySQL · 备库优化 ·  relay fetch 备库优化
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2015/09/09/" target="_blank">
                
                MySQL · 特性分析 · 5.6并行复制事件分发机制
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/09/10/" target="_blank">
                
                MySQL · TokuDB · 文件目录谈
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 特性分析 · 5.6并行复制事件分发机制
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <h2>并行复制相关线程</h2>

<p>在MySQL 5.6并行复制中，当设置<code>set global slave_parallel_workers=2</code>时，共有4个复制相关的线程，如下：</p>

<pre><code>+----+-------------+------+-------+---------+------+------------------------------------------------------------------+------+
| ID | USER        | HOST | DB    | COMMAND | TIME | STATE                                                            | INFO |
+----+-------------+------+-------+---------+------+------------------------------------------------------------------+------+
| 23 | system user |      | NULL  | Connect |    3 | Waiting for master to send event                                 | NULL |
| 24 | system user |      | mysql | Connect |    3 | Slave has read all relay log; waiting for the slave I/O thread t | NULL |
| 25 | system user |      | NULL  | Connect |    3 | Waiting for an event from Coordinator                            | NULL |
| 26 | system user |      | NULL  | Connect |    3 | Waiting for an event from Coordinator                            | NULL |
+----+-------------+------+-------+---------+------+------------------------------------------------------------------+------+
</code></pre>

<p>其中第一个为IO线程，负责从主库拉取binlog到备库并存为relay log;<br />
第二个为分发线程，负责解析relay log，并将解析后的事件分发给worker线程处理；<br />
其余两个为worker线程负责处理分发后的事件，类型非并行复制时的sql线程。</p>

<h2>并行复制并发策略</h2>

<p>目前RDS MySQL并行复制是以表级别进行分发的，即同一时刻，同一个表相关的操作只能在同一个worker线程中进行。</p>

<p>考虑两个事务，分别对表进行insert</p>

<pre><code>trx1:
begin;
insert into t1 values(1);
comit;

trx2:
begin;
insert into t2 values(1);
comit;
</code></pre>

<p>那么这两个事务可能分别在两个worker中并行执行。</p>

<p>有些特殊情会影响worker的并发执行:</p>

<ul>
  <li>并行退化为串行的情况
    <ul>
      <li>DDL语句串行处理(RDS MySQL正在优化DDL并行处理)</li>
      <li>binlog切换事件需串行处理</li>
      <li>有外键关系的表需串行处理</li>
    </ul>
  </li>
  <li>并行等待的情况</li>
</ul>

<p>当一个事务中包含多个表时，如下:</p>

<pre><code>trx3:
begin;
insert into t1 values(3);
insert into t2 values(3);
comit;
</code></pre>

<p>如果当前worker1正在执行t1相关的事务，worker2正在执行t2相关的事务，那么分发线程在分发trx3的t2的事件时必须等待worker2的t2相关的事务执行完成。</p>

<h2>并行复制worker分配</h2>

<p>假设，worker线程正在执行的情况如下:</p>

<pre><code>worker 1: trx1: insert t1
worker 2: trx2: insert t2;  trx3: insert t3;
</code></pre>

<p>然后分发线程再来一个事务trx4:</p>

<pre><code>trx4: insert t4;
</code></pre>

<p>分发线程该分配给哪个worker呢？</p>

<p>分配线程分配会分配给最空闲的worker(<code>get_least_occupied_worker</code>);</p>

<p><strong>这里最空闲是指worker当前正在执行的事务涉及的表数越少越空闲。</strong></p>

<p>worker1正在执行的事务涉及的表数为1，而worker2正在执行的事务涉及的表数为2，因此trx4会分配为worker1;</p>

<p>表和worker存在一一对应关系，为了快速找到表对应的worker，哈希表（<code>mapping_db_to_worker</code>）存储了这种映射关系。同时为了控制哈希表过大导致占用较多内存或哈希冲突，系统严格控制了哈希表的大小，不能超过16（硬编码<code>mts_partition_hash_soft_max</code>），当超过16时，会将当前没有执行的表从哈希表驱逐出去。</p>

<p>在表较多情况下，哈希表大小设为16显得过小，可能会频繁驱逐表，频繁新建哈希键值对的情况。</p>

<h2>优化</h2>

<ol>
  <li>表级并行复制下，哈希表的大小16（硬编码<code>mts_partition_hash_soft_max</code>）过小，应设为动态可调；</li>
  <li>分配线程分配会分配给最空闲的<code>worker(get_least_occupied_worker)</code>。</li>
</ol>

<p>考虑如下情况：</p>

<pre><code>worker 1: t1 1000个事务
worker 2: t2 10个事务  t3 10 个事务
</code></pre>

<p>当前worker1比worker2要繁忙，而按照当前正在执行的事务涉及的表数越少越空闲的原则，新来的事务(比如insert t4)会分配给worker1，这是不合理的。<br />
因此，空闲的标准应改为当前正在执行的事务数越少越空闲，这样新来的事务会分配给worker2。</p>

    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
