<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 特性分析 · 线程池</title>
  <meta name="description" content="概述">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2016/02/09/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2016/02">
    <h1>数据库内核月报 － 2016 / 02</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2016/02/08/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2016/02/10/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/01/" target="_blank">
                
                MySQL · 引擎特性 · InnoDB 文件系统之文件物理结构
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/02/" target="_blank">
                
                MySQL · 引擎特性 · InnoDB 文件系统之IO系统和内存管理
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/03/" target="_blank">
                
                MySQL · 特性分析 · InnoDB transaction history
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/04/" target="_blank">
                
                PgSQL · 会议见闻 · PgConf.Russia 2016 大会总结
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/05/" target="_blank">
                
                PgSQL · 答疑解惑 · PostgreSQL 9.6 并行查询实现分析
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/06/" target="_blank">
                
                MySQL · TokuDB · TokuDB之黑科技工具
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/07/" target="_blank">
                
                PgSQL · 性能优化 · PostgreSQL TPC-C极限优化玩法
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/08/" target="_blank">
                
                MariaDB · 版本特性 · MariaDB 的 GTID 介绍
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2016/02/09/" target="_blank">
                
                MySQL · 特性分析 · 线程池
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/02/10/" target="_blank">
                
                MySQL · 答疑解惑 · mysqldump tips 两则
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 特性分析 · 线程池
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <h2>概述</h2>

<p>MySQL 原有线程调度方式有每个连接一个线程(one-thread-per-connection)和所有连接一个线程（no-threads）。</p>

<p>no-threads一般用于调试，生产环境一般用one-thread-per-connection方式。one-thread-per-connection 适合于低并发长连接的环境，而在高并发或大量短连接环境下，大量创建和销毁线程，以及线程上下文切换，会严重影响性能。另外 one-thread-per-connection 对于大量连接数扩展也会影响性能。</p>

<p>为了解决上述问题，MariaDB、Percona、Oracle MySQL 都推出了线程池方案，它们的实现方式大体相似，这里以 Percona 为例来简略介绍实现原理，同时会介绍我们在其基础上的一些改进。</p>

<h2>实现</h2>

<p>线程池方案下，用户的每个连接不再对应一个线程。线程池由一系列 worker 线程组成，这些worker线程被分为<code>thread_pool_size</code>个group。用户的连接按 round-robin 的方式映射到相应的group 中，一个连接可以由一个group中的一个或多个worker线程来处理。</p>

<ol>
  <li>
    <p>listener 线程<br />
每个group中有一个listener线程，通过epoll的方式来监听本group中连接的事件。listener线程同时也是worker线程，listener线程不是固定的。<br />
listener线程监听到连接事件后会将事件放入优先级队列中，listener线程作为worker线程也处理一些连接事件，以减少上下文切换。<br />
listener线程会检查优先级队列是否为空，如果为空表示网络空闲，listener线程会作为worker线程处理第一个监听事件，其他事件仍然放入优先级队列中。<br />
另外，当没有活跃线时，listener会唤醒一个线程，如果没有线程可以唤醒，且当前group只有一个线程且为listener，则创建一个线程。</p>
  </li>
  <li>
    <p>优先级队列<br />
分为高优先级队列和普通队列，已经开启的事务并且tickets不为0，放入高优先队列，否则放入普通队列。每个连接在<code>thread_pool_high_prio_tickets</code>次被放到优先队列中后，会移到普通队列中。worker线程先从高优先队列取event处理，只有当高优先队列为空时才从普通队列取event处理。<br />
通过优先级队列，可以让已经开启的事务或短事务得到优先处理，及时提交释放锁等资源。</p>
  </li>
  <li>
    <p>worker 线程<br />
worker线程负责从优先队列取事件处理。如果没有取到event，会尝试从epoll中取一个，如果没有取到再进入等待，如果等待超过<code>thread_pool_idle_timeout</code> worker线程会退出。</p>
  </li>
  <li>timer 线程<br />
每隔<code>thread_pool_stall_limit</code>时间检查一次。
    <ul>
      <li>listener没有接收新的事件，listener正在等待时需调用<code>wake_or_create_thread</code>，重新创建listener；</li>
      <li>从上一次检查起，worker线程没有收到新的事件，并且队列不为空，则认为发生了stall，需唤醒或创建worker线程；</li>
      <li>检查<code>net_wait_timeout</code>是否超时，如果超时退出连接，而不是退出worker线程。</li>
    </ul>
  </li>
  <li>何时唤醒或创建worker线程
    <ul>
      <li>从队列中取事件时发现没有活跃线程时；</li>
      <li>worker线程发生等待且没有活跃线程时；</li>
      <li>timer线程认为发生了stall；</li>
    </ul>
  </li>
</ol>

<h2>重要参数解析</h2>

<ol>
  <li>
    <p><code>thread_pool_oversubscribe</code><br />
 一个group中活跃线程和等待中的线程超过<code>thread_pool_oversubscribe</code>时，不会创建新的线程。<br />
 此参数可以控制系统的并发数，同时可以防止调度上的死锁，考虑如下情况，A、B、C三个事务，A、B 需等待C提交。A、B先得到调度，同时活跃线程数达到了<code>thread_pool_max_threads</code>上限，随后C继续执行提交，此时已经没有线程来处理C提交，从而导致A、B一直等待。<code>thread_pool_oversubscribe</code>控制group中活跃线程和等待中的线程总数，从而防止了上述情况。</p>
  </li>
  <li>
    <p><code>thread_pool_stall_limit</code><br />
timer线程检测间隔。此参数设置过小，会导致创建过多的线程，从而产生较多的线程上下文切换，但可以及时处理锁等待的场景，避免死锁。参数设置过大，对长语句有益，但会阻塞短语句的执行。参数设置需视具体情况而定，例如99%的语句10ms内可以完成，那么我们可以将就<code>thread_pool_stall_limit</code>设置为10ms</p>
  </li>
</ol>

<h2>一些改进</h2>

<ol>
  <li>
    <p>lock tables read 的处理<br />
对于声明 lock tables read 等明确声明表锁的事件，放入高优先级队列。</p>
  </li>
  <li>
    <p>binlog dump线程的处理<br />
binlog dump线程是典型的长事务场景，当多个binlog dump线程分配到同一个group中时，group中的线程很容易超过<code>thread_pool_oversubscribe</code>限制，从而导致性能下降。<br />
优化方法是修改binlog dump线程不受<code>thread_pool_oversubscribe</code>限制。</p>
  </li>
  <li>
    <p>丰富诊断信息<code>information_schema.thread_group_status</code></p>

    <pre><code> show create table THREAD_GROUP_STATUS\G
 *************************** 1. row ***************************
        Table: THREAD_GROUP_STATUS
 Create Table: CREATE TEMPORARY TABLE `THREAD_GROUP_STATUS` (
   `ID` int(21) unsigned NOT NULL DEFAULT '0',
   `THREAD_COUNT` int(21) unsigned NOT NULL DEFAULT '0',
   `ACTIVE_THREAD_COUNT` int(21) unsigned NOT NULL DEFAULT '0',
   `CONNECTION_COUNT` int(21) unsigned NOT NULL DEFAULT '0',
   `WAITING_THREAD_COUNT` int(21) unsigned NOT NULL DEFAULT '0',
   `DUMP_COUNT` bigint(21) unsigned NOT NULL DEFAULT '0',
   `LOW_QUEUE_COUNT` bigint(21) unsigned NOT NULL DEFAULT '0',
   `HIGH_QUEUE_COUNT` bigint(21) unsigned NOT NULL DEFAULT '0'
 ) ENGINE=MEMORY DEFAULT CHARSET=utf8
</code></pre>
  </li>
  <li>
    <p>线程池调度异常，无法连接的处理<br />
对于本地登录的用户，走老的<code>one_thread_per_connection</code>逻辑，从而解决无法连接的情况。</p>
  </li>
</ol>

<h2>连接池和线程池的区别</h2>

<p>最后说一点连接池和线程池的区别。连接池和线程池是两个独立的概念，连接池是在客户端的优化，缓存客户的连接，避免重复创建和销毁连接。而线程池是服务器端的优化。两者的优化角度不同，不相关，因此两种优化可以同时使用。</p>

    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
