<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 捉虫动态 · MySQL 外键异常分析</title>
  <meta name="description" content="外键约束异常现象如下测例中，没有违反引用约束的插入失败。">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2015/11/06/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2015/11">
    <h1>数据库内核月报 － 2015 / 11</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2015/11/05/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2015/11/07/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/01/" target="_blank">
                
                MySQL · 社区见闻 · OOW 2015 总结 MySQL 篇
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/02/" target="_blank">
                
                MySQL · 特性分析 · Statement Digest
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/03/" target="_blank">
                
                PgSQL · 答疑解惑 · PostgreSQL 用户组权限管理
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/04/" target="_blank">
                
                MySQL · 特性分析 · MDL 实现分析
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/05/" target="_blank">
                
                PgSQL · 特性分析 · full page write 机制
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2015/11/06/" target="_blank">
                
                MySQL · 捉虫动态 · MySQL 外键异常分析
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/07/" target="_blank">
                
                MySQL · 答疑解惑 · MySQL 优化器 range 的代价计算
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/08/" target="_blank">
                
                MySQL · 捉虫动态 · ORDER/GROUP BY 导致 mysqld crash
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/09/" target="_blank">
                
                MySQL · TokuDB · TokuDB 中的行锁
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/11/10/" target="_blank">
                
                MySQL · 捉虫动态 · order by limit 造成优化器选择索引错误
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 捉虫动态 · MySQL 外键异常分析
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <h2>外键约束异常现象</h2>
<p>如下测例中，没有违反引用约束的插入失败。</p>

<pre><code>create database `a-b`;
use `a-b`;
SET FOREIGN_KEY_CHECKS=0;
create table t1(c1 int primary key, c2 int) engine=innodb;
create table t2(c1 int primary key, c2 int) engine=innodb;
alter table t2 add  foreign key(c2)  references `a-b`.t1(c1);
SET FOREIGN_KEY_CHECKS=1;
insert into t1 values(1,1);
select * from t1;
c1      c2
1       1
select * from t2;
c1      c2
insert into t2 values(1,1);
ERROR 23000: Cannot add or update a child row: a foreign key constraint fails (`a-b`.`t2`, CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`c2`) REFERENCES `a-b`.`t1` (`c1`))
insert into t2 values(1,1); //预期应该成功实际失败了。子表插入任何数据都会报违反引用约束。
</code></pre>

<h2>异常分析</h2>

<p>首先我们会检查表结构是否正常</p>

<pre><code>show create table t2;
Table   Create Table
t2      CREATE TABLE `t2` (
  `c1` int(11) NOT NULL,
  `c2` int(11) DEFAULT NULL,
  PRIMARY KEY (`c1`),
  KEY `c2` (`c2`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`c2`) REFERENCES `a-b`.`t1` (`c1`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
</code></pre>

<p>查看 innodb_sys_foreign 表</p>

<pre><code>select * from information_schema.innodb_sys_foreign where id='a@002db/t2_ibfk_1';
+-------------------+------------+----------+--------+------+
| ID                | FOR_NAME   | REF_NAME | N_COLS | TYPE |
+-------------------+------------+----------+--------+------+
| a@002db/t2_ibfk_1 | a@002db/t2 | a-b/t1   |      1 |    0 |
+-------------------+------------+----------+--------+------+

select * from information_schema.innodb_sys_tables where name='a@002db/t1';
+----------+------------+------+--------+-------+-------------+------------+---------------+
| TABLE_ID | NAME       | FLAG | N_COLS | SPACE | FILE_FORMAT | ROW_FORMAT | ZIP_PAGE_SIZE |
+----------+------------+------+--------+-------+-------------+------------+---------------+
|      530 | a@002db/t1 |    1 |      5 |   525 | Antelope    | Compact    |             0 |
+----------+------------+------+--------+-------+-------------+------------+---------------+
</code></pre>

<p>表结构正常，表面上看外键在系统表中元数据库信息正常。仔细比较发现 innodb_sys_foreign 的REF_NAME字段”a-b/t1”实际应为”a@002db/t2”。</p>

<h2>MySQL内部表名和库名存储格式</h2>

<p>MySQL 内部用 my_charset_filename 字符集来表名和库名。</p>

<p>以下数组定义了 my_charset_filename 字符集需要转换的字符。数组下标为 ascii 值，1代表不需要转换。可以看到字母数字和下划线等不需要转换，同时字符’-‘是需要转换的， 转换函数参见<code>my_wc_mb_filename</code>。</p>

<pre><code>static char filename_safe_char[128]=
{
  1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /* ................ */
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /* ................ */
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*  !"#$%&amp;'()*+,-./ */
  1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0, /* 0123456789:;&lt;=&gt;? */
  0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, /* @ABCDEFGHIJKLMNO */
  1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1, /* PQRSTUVWXYZ[\]^_ */
  0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, /* `abcdefghijklmno */
  1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0, /* pqrstuvwxyz{|}~. */
};
</code></pre>

<h2>异常分析</h2>

<p>由上节可知，字符’-‘作为库名或表名是需要转换的。innodb_sys_foreign 中 FOR_NAME 值是转换过的，只有 REF_NAME 未转换，而系统表 innodb_sys_tables 中存储的表名是转换后的。<code>dict_get_referenced_table</code> 根据未转换的表名 a-b/t1 去系统表 SYS_TABLES 查找会查找不到记录。于是会导致</p>

<pre><code> foreign-&gt;referenced_table==NULL
</code></pre>

<p>因此对子表的任何插入都会返回错误 DB_NO_REFERENCED_ROW，如下代码</p>

<pre><code>row_ins_check_foreign_constraint:

 if (check_ref) {
         check_table = foreign-&gt;referenced_table;
         check_index = foreign-&gt;referenced_index;
 } else {
         check_table = foreign-&gt;foreign_table;
         check_index = foreign-&gt;foreign_index;
 }

if (check_table == NULL
    || check_table-&gt;ibd_file_missing
    || check_index == NULL) {

        if (!srv_read_only_mode &amp;&amp; check_ref) {
                ……
                err = DB_NO_REFERENCED_ROW;
        }

        goto exit_func;
</code></pre>

<p>经过进一步调试分析发现，函数<code>innobase_get_foreign_key_info</code>中主表的库名和表名都没有经过转换，而是直接使用系统字符集。</p>

<p>回过头再看看bug的触发条件：</p>

<ol>
  <li>表名或库名包含特殊字符；</li>
  <li>此表作为引用约束的主表；</li>
  <li>增加引用约束是设置了SET FOREIGN_KEY_CHECKS=0；</li>
</ol>

<p>这里强调下第3条, 如果上面的测例中去掉了SET FOREIGN_KEY_CHECKS=0，那么结果 REF_NAME会正常转换</p>

<pre><code>SET FOREIGN_KEY_CHECKS=1;
create table t1(c1 int primary key, c2 int) engine=innodb;
create table t2(c1 int primary key, c2 int) engine=innodb;
alter table t2 add  foreign key(c2)  references `a-b`.t1(c1);
select * from information_schema.innodb_sys_foreign where id='a@002db/t2_ibfk_1';
+-------------------+------------+------------+--------+------+
| ID                | FOR_NAME   | REF_NAME   | N_COLS | TYPE |
+-------------------+------------+------------+--------+------+
| a@002db/t2_ibfk_1 | a@002db/t2 | a@002db/t1 |      1 |    0 |
+-------------------+------------+------------+--------+------+
</code></pre>

<h2>online DDL 与 foreign key</h2>

<p>MySQL 5.6 online DDL 是支持建索引的。而对于建外键索引同样也是支持的，条件是SET FOREIGN_KEY_CHECKS=0。</p>

<pre><code>ha_innobase::check_if_supported_inplace_alter：
 if ((ha_alter_info-&gt;handler_flags
      &amp; Alter_inplace_info::ADD_FOREIGN_KEY)
     &amp;&amp; prebuilt-&gt;trx-&gt;check_foreigns) {
         ha_alter_info-&gt;unsupported_reason = innobase_get_err_msg(
                 ER_ALTER_OPERATION_NOT_SUPPORTED_REASON_FK_CHECK);
         DBUG_RETURN(HA_ALTER_INPLACE_NOT_SUPPORTED);
 }
</code></pre>

<p>SET FOREIGN_KEY_CHECKS=0时，<code>prebuilt-&gt;trx-&gt;check_foreigns</code>为false。</p>

<p>我们再来看出问题的函数<code>innobase_get_foreign_key_info</code>，只有online DDL的代码路径才会调用此函数：</p>

<pre><code>#0  innobase_get_foreign_key_info
#1  ha_innobase::prepare_inplace_alter_table
#2  handler::ha_prepare_inplace_alter_table
#3  mysql_inplace_alter_table
#4  mysql_alter_table
......
</code></pre>

<p>而非online DDL的路径如下，函数 <code>dict_scan_id</code> 会对表名和库名进行转换：</p>

<pre><code>#0  dict_scan_id
#1  dict_scan_table_name
#2  dict_create_foreign_constraints_low
#3  dict_create_foreign_constraints
#4  row_table_add_foreign_constraints
#5  ha_innobase::create
#6  handler::ha_create
#7  ha_create_table
#8  mysql_alter_table
......
</code></pre>

<h2>修复</h2>

<p>bug系统中虽然没有相关的bug信息，但从MySQL 5.6.26中我们看到官方Bug#21094069已经进行了修复，在<code>innobase_get_foreign_key_info</code>中对库名和表名进行转换。</p>

<p>参考commit:<a href="https://github.com/mysql/mysql-server/commit/1fae0d42c352908fed03e29db2b391a0d2969269">1fae0d42c352908fed03e29db2b391a0d2969269</a></p>

    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
