<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · TokuDB · 让Hot Backup更完美</title>
  <meta name="description" content="前言很久很久以前，内核君发表了一篇HA方案·TokuDB热备的文章，方法很简单：">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2015/12/06/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2015/12">
    <h1>数据库内核月报 － 2015 / 12</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2015/12/05/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2015/12/07/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/01/" target="_blank">
                
                MySQL · 引擎特性 · InnoDB 事务子系统介绍
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/02/" target="_blank">
                
                PgSQL · 特性介绍 · 全文搜索介绍
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/03/" target="_blank">
                
                MongoDB · 捉虫动态 · Kill Hang问题排查记录
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/04/" target="_blank">
                
                MySQL · 参数优化 ·RDS MySQL参数调优最佳实践
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/05/" target="_blank">
                
                PgSQL · 特性分析 · 备库激活过程分析
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2015/12/06/" target="_blank">
                
                MySQL · TokuDB · 让Hot Backup更完美
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/07/" target="_blank">
                
                PgSQL · 答疑解惑 · 表膨胀
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/08/" target="_blank">
                
                MySQL · 特性分析 · Index Condition Pushdown (ICP)
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/09/" target="_blank">
                
                MariaDB · 社区动态 · MariaDB on Power8
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/12/10/" target="_blank">
                
                MySQL · 特性分析 · 企业版特性一览
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · TokuDB · 让Hot Backup更完美
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <h2>前言</h2>
<p>很久很久以前，内核君发表了一篇<a href="http://mysql.taobao.org/index.php?title=MySQL%E5%86%85%E6%A0%B8%E6%9C%88%E6%8A%A5_2014.09#TokuDB.C2.B7_HA.E6.96.B9.E6.A1.88.C2.B7TokuDB.E7.83.AD.E5.A4.87">HA方案·TokuDB热备</a>的文章，方法很简单：</p>

<ol>
  <li>SET TOKUDB_CHECKPOINT_LOCK=ON;</li>
  <li>开始拷贝TokuDB的数据文件(不包含日志文件)；</li>
  <li>FLUSH TABLES WITH READ LOCK;</li>
  <li>记录binlog位置，拷贝最新的binlog和TokuDB的日志文件(*.tokulog)；</li>
  <li>UNLOCK TABLES;</li>
  <li>SET TOKUDB_CHECKPOINT_LOCK=OFF;</li>
</ol>

<p>这些步骤可以很方便的嵌入到Percona XtraBackup中，与InnoDB一起工作，目前看是一个比较简单可行的方案。</p>

<h2>大实例备份恢复问题</h2>

<p>问题来了。<br />
当某个实例的数据量达到TB级，你会发现备库(基于备份)重搭后，启动会灰常灰常慢，因为他们都在recover redo-log，为什么呢？</p>

<ol>
  <li>SET TOKUDB_CHECKPOINT_LOCK=ON;</li>
  <li>开始拷贝TokuDB的数据文件(不包含日志文件)，由于拷贝TB级的数据非常耗时，redo log持续增加甚至上万个</li>
</ol>

<p>当TokuDB启动后，扫描和recover这几万个redo log将是灾难性的。</p>

<p>解决这个问题比较简单，我们稍微调整下热备的顺序即可：</p>

<ol>
  <li>SET TOKUDB_CHECKPOINT_LOCK=ON;</li>
  <li>FLUSH TABLES WITH READ LOCK;</li>
  <li>记录binlog位置，拷贝最新的binlog和TokuDB的日志文件(*.tokulog)；</li>
  <li>UNLOCK TABLES;</li>
  <li>开始拷贝TokuDB的数据文件(不包含日志文件)  –移动到这里</li>
  <li>SET TOKUDB_CHECKPOINT_LOCK=OFF;</li>
</ol>

<p>这样在拷贝TokuDB数据文件的时候，就跟redo-log没半毛钱关系了，而且拷贝的redo-log数也大大减少！</p>

<h2>优化改进</h2>

<p>本以为这样就可以早点下班回家，但问题还是来。</p>

<p>某实例有几十万个TokuDB文件(分区表文件)，使用热备的数据备库重搭后，复制过程中偶尔会出现”Duplicate entry … for key ‘PRIMARY’“错误。</p>

<p>引起这个错误的原因比较深，触发自TokuDB内部机制。</p>

<p>TokuDB每个分区表有数个文件组成（想了解TokuDB数据库文件的请<a href="http://mysql.taobao.org/monthly/2015/09/10/">轻戳这里</a>），当分区表非常多的时候，打开的文件句柄数会非常多，受限于<code>open_files_limit</code>配置，TokuDB底层会触发句柄关闭机制，对当前文件进行checkpoint操作(新数据被刷到磁盘且生效)再做close，这样即使拿到checkpoint锁后，还是有数据被写入，就引发了以上问题。</p>

<p>为了解决这个问题，我们在热备的过程中引入一个状态：in_backup = true，防止文件关闭做checkpoint操作，具体的patch见<a href="https://github.com/percona/PerconaFT/pull/331/files">这里</a>。</p>

<p>这样TokuDB的热备就比较完美了，整个热备过程中，所有的数据文件均处于一个“一致性”状态，所有的操作都在redo-log里，不再污染数据文件。</p>


    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
