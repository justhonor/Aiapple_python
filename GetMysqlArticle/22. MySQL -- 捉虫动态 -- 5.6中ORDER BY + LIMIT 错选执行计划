<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 捉虫动态 · 5.6中ORDER BY + LIMIT 错选执行计划</title>
  <meta name="description" content="问题描述">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2016/12/08/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2016/12">
    <h1>数据库内核月报 － 2016 / 12</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2016/12/07/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2016/12/09/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/01/" target="_blank">
                
                MySQL · 引擎特性 · Infobright 列存数据库
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/02/" target="_blank">
                
                MySQL · myrocks · myrocks统计信息
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/03/" target="_blank">
                
                SQL Server · 特性介绍 · 统计信息
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/04/" target="_blank">
                
                PgSQL · 案例分享 · 从春运抢火车票思考数据库设计
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/05/" target="_blank">
                
                HybridDB · 最佳实践 · OLAP和OLTP一体化打造
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/06/" target="_blank">
                
                TokuDB · 特性分析 · 导入数据大杀器：Loader
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/07/" target="_blank">
                
                PgSQL · 案例分享 · PostgreSQL 性能诊断指南
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2016/12/08/" target="_blank">
                
                MySQL · 捉虫动态 · 5.6中ORDER BY + LIMIT 错选执行计划
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/09/" target="_blank">
                
                Redis · 最佳实践 · 阿里云Redis助力双11业务
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2016/12/10/" target="_blank">
                
                PgSQL · 案例分享 · 递归收敛优化
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 捉虫动态 · 5.6中ORDER BY + LIMIT 错选执行计划
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <h2>问题描述</h2>

<pre><code>create table t1(id int auto_increment primary key, a int, b int, c int, v varchar(1000), key iabc(a,b,c), key ic(c)) engine = innodb;

insert into t1 select null,null,null,null,null;
insert into t1 select null,null,null,null,null from t1;
insert into t1 select null,null,null,null,null from t1;
insert into t1 select null,null,null,null,null from t1;
insert into t1 select null,null,null,null,null from t1;
insert into t1 select null,null,null,null,null from t1;

update t1 set a=id/2, b=id/4, c=6-id/8, v=repeat('a',1000);

explain select id from t1 where a&lt;3 and b in (1, 13) and c&gt;=3 order by c desc limit 2;
+----+-------------+-------+-------+---------------+------+---------+------+------+------------------------------------------+
| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows | Extra                                    |
+----+-------------+-------+-------+---------------+------+---------+------+------+------------------------------------------+
|  1 | SIMPLE      | t1    | index | iabc,ic       | iabc | 15      | NULL |   32 | Using where; Using index; Using filesort |
+----+-------------+-------+-------+---------------+------+---------+------+------+------------------------------------------+

explain select id from t1 force index (iabc) where a&lt;3 and b in (1, 13) and c&gt;=3 order by c desc limit 2;
+----+-------------+-------+-------+---------------+------+---------+------+------+------------------------------------------+
| id | select_type | table | type  | possible_keys | key  | key_len | ref  | rows | Extra                                    |
+----+-------------+-------+-------+---------------+------+---------+------+------+------------------------------------------+
|  1 | SIMPLE      | t1    | range | iabc          | iabc | 5       | NULL |    3 | Using where; Using index; Using filesort |
+----+-------------+-------+-------+---------------+------+---------+------+------+------------------------------------------+
</code></pre>
<p>从SELECT语句中可以看出，同样的语句，使用同样的INDEX，但使用了FORCE INDEX之后选择的执行计划不一样。当然如果数据量大的话，实际的执行性能也会差别很大。使用RANGE scan显然要优于INDEX scan的全扫描。</p>

<p>另外此bug引发的另一个问题是，由于使用了LIMIT语句，导致选择的INDEX不是最优的INDEX。</p>

<h2>问题分析：</h2>
<p>使用如下命令打开Optimizer trace</p>

<pre><code>SET OPTIMIZER_TRACE_MAX_MEM_SIZE=268435456(i.e. 256M);
SET optimizer_trace="enabled=on";
</code></pre>
<p>执行上面的查询语句，可以看到optimizer trace的输出结果如下，请注意里面重点部位的注释（以’//’开头部分)：</p>

<pre><code>"considered_execution_plans": [\
              {\
                "plan_prefix": [\
                ],\
                "table": "`t1`",\
                "best_access_path": {\
                  "considered_access_paths": [\
                    {\
                      "access_type": "range",\  
					  // 这里我们可以看到，优化器通过代价选择的最佳访问方式是RANGE scan
                      "rows": 3,\
                      "cost": 2.2146,\
                      "chosen": true\
                    }\
                  ]\
                },\
                "cost_for_plan": 2.2146,\
                "rows_for_plan": 3,\
                "chosen": true\
              }\
            ]\
但是接下来我们可以看到：
       "refine_plan": [\
              {\
                "table": "`t1`",\
				
                "access_type": "index_scan"\ //这里强制使用了INDEX scan
              }\
            ]\
</code></pre>

<p>这里显示的是optimizer在执行优化器的第四个阶段，PLAN REFINEMENT的时候，最后选择了INDEX scan。所以我们可以大致确定错误发生的地方。另外有问题的query带有LIMIT，因此基本可以确定问题发生在了make_join_select函数中。</p>

<p>make_join_select函数中有下面一段逻辑：</p>

<pre><code>if (!tab-&gt;const_keys.is_clear_all() &amp;&amp;               // 有依赖于常量的索引条件表达式
                   i == join-&gt;const_tables &amp;&amp;        // 是第一个非常量表
                   (join-&gt;unit-&gt;select_limit_cnt &lt;
                    tab-&gt;position-&gt;records_read) &amp;&amp;  
					// 有Limit条件且需要返回的行数比估计扫描的行数少
                   !(join-&gt;select_options &amp; OPTION_FOUND_ROWS))  // 没有SQL_CALC_FOUND_ROWS
            recheck_reason= LOW_LIMIT;  // 这里MySQL开始对Limit语句进行优化
			...
// 检查是否有RANGE scan可以使用
if ((recheck_reason != DONT_RECHECK) &amp;&amp;
                sel-&gt;test_quick_select(thd, usable_keys,
                                       used_tables &amp; ~tab-&gt;table-&gt;map,
                                       (join-&gt;select_options &amp;
                                        OPTION_FOUND_ROWS ?
                                        HA_POS_ERROR :
                                        join-&gt;unit-&gt;select_limit_cnt),
                                       false,   // don't force quick range
                                       interesting_order) &lt; 0)
            {
这里usable_keys是描述可以用来对ORDER BY列进行索引排序的可能的所有索引的MAP。上面的函数会查找这些可用的索引是否可以进行更高效RANGE
扫描。但是通过问题query的条件表达式，这里没有找到对应的RANGE扫描，所以最后的执行计划输出只是使用了一个COVERING index.
</code></pre>

<h2>问题解决</h2>

<p>解决方式是需要将原来已经选好的RANGE scan与用来进行排序的索引扫描代价进行比较，比较哪种扫描方式对于增加ORDER BY操作后的代价更低，进而选择一个代价最优的扫描方式。下面是一个相关的patch。</p>

<pre><code>if (!tab-&gt;const_keys.is_clear_all() &amp;&amp;               // 有依赖于常量的索引条件表达式
                   i == join-&gt;const_tables &amp;&amp;        // 是第一个非常量表
                   (join-&gt;unit-&gt;select_limit_cnt &lt;
                    tab-&gt;position-&gt;records_read) &amp;&amp;  // 有Limit条件且需要返回的行数比估计的扫描的行数少
                   !(join-&gt;select_options &amp; OPTION_FOUND_ROWS))  // 没有SQL_CALC_FOUND_ROWS
            recheck_reason= LOW_LIMIT;  //这里MySQL会去对Limit语句进行优化
			...
+              if (recheck_reason != DONT_RECHECK)
               {
-                recheck_reason= DONT_RECHECK;
+                int best_key= -1;
+                ha_rows select_limit= join-&gt;unit-&gt;select_limit_cnt;
+
+                // 对所有可用的INDEX计算排序代价，选择一个代价最优的INDEX
				 // 注意：这里的usable_keys包含所有可用索引，而不只是原来版本中只包含可以用来排序的索引
+                test_if_cheaper_ordering(tab, join-&gt;order, tab-&gt;table,
+                                         usable_keys, -1, select_limit,
+                                         &amp;best_key, &amp;read_direction,
+                                         &amp;select_limit);
				 // 如果没有找到任何可用的INDEX，那就默认使用原来的扫描方式
+                if (best_key &lt; 0)
+                  recheck_reason= DONT_RECHECK; // No usable keys
+                else
+                {
+                  // 找到一个最优的INDEX，我们只需要设置可用的INDEX，接下来查看一下是否有RANGE scan即可
+                  usable_keys.clear_all();
+                  usable_keys.set_bit(best_key);
+                  interesting_order= (read_direction == -1 ? ORDER::ORDER_DESC :
+                                      ORDER::ORDER_ASC);
+                }
               }
             }
if ((recheck_reason != DONT_RECHECK) &amp;&amp;
                sel-&gt;test_quick_select(thd, usable_keys,
                                       used_tables &amp; ~tab-&gt;table-&gt;map,
                                       (join-&gt;select_options &amp;
                                        OPTION_FOUND_ROWS ?
                                        HA_POS_ERROR :
                                        join-&gt;unit-&gt;select_limit_cnt),
                                       false,   // don't force quick range
                                       interesting_order) &lt; 0)
            {
			...
</code></pre>

<p>可以看到最终效果是：</p>

<pre><code>EXPLAIN SELECT id FROM t1 WHERE a&lt;3 AND b IN (1, 13) AND c&gt;=3 ORDER BY c DESC LIMIT 2;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE		t1		range	iabc,ic			iabc	5	NULL	4	Using index condition; Using filesort
</code></pre>

    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
