<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MySQL · 捉虫动态 · 连接断开导致XA事务丢失</title>
  <meta name="description" content="我们看到在MySQL 5.7版本里大量遗留很多年的bug都被fix掉了，bug#12161就是其中一个，该bug在2005年第一次report到Bug list上，十年之后终于在MySQL 5.7.7 第一个RC版本被fix了。">

  <link rel="stylesheet" href="/monthly/css/typo.css">
  <link rel="stylesheet" href="/monthly/css/animate.css">
  <link rel="stylesheet" href="/monthly/css/main.css">
  <link rel="canonical" href="http://mysql.taobao.org//monthly/2015/04/05/">
  <link rel="alternate" type="application/rss+xml" title="数据库内核月报" href="http://mysql.taobao.org//monthly/feed.xml" />

  <link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/8.3/styles/tomorrow.min.css">
  <script src="/monthly/js/highlight.min.js"></script>
  <!-- <link rel="stylesheet" href="/monthly/themes/tomorrow.css">
  <script src="/monthly/highlight/highlight.pack.js"> -->
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.js"></script>
  <script src="http://cdn.staticfile.org/jquery/1.11.1/jquery.min.map"></script>

  <script src="/monthly/scripts/changeTarget.js"></script>
  
</head>


<!-- Google Analysis -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62056244-1', 'auto');
  ga('send', 'pageview');
</script>


  <body>

    <header>

  <a id="go-back-home" href="/monthly/2015/04">
    <h1>数据库内核月报 － 2015 / 04</h1>
  </a>

</header>


        <section class="paging">
  
  
  

  
    
      <div class="left">
        <a href="/monthly/2015/04/04/">
          ‹
        </a>
      </div>
    
  
  
    
      <div class="right">
        <a href="/monthly/2015/04/06/">
          ›
        </a>
      </div>
    
  
</section>


<div id = "container" class = "animated zoomIn">
  <div class="block">
  <nav id="primary_nav_wrap">
<ul>
  <li><a href="#">当期文章</a>
    <ul  class = "animated">
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/01/" target="_blank">
                
                MySQL · 引擎特性 · InnoDB undo log 漫游
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/02/" target="_blank">
                
                TokuDB · 产品新闻 · RDS TokuDB小手册
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/03/" target="_blank">
                
                TokuDB · 特性分析 · 行锁(row-lock)与区间锁(range-lock)
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/04/" target="_blank">
                
                PgSQL · 社区动态 · 说一说PgSQL 9.4.1中的那些安全补丁
              </a>
            </li>
          
      
          
          

          
            
              <li class="current-menu-item">
            
              <a href="/monthly/2015/04/05/" target="_blank">
                
                MySQL · 捉虫动态 · 连接断开导致XA事务丢失
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/06/" target="_blank">
                
                MySQL · 捉虫动态 · GTID下slave_net_timeout值太小问题
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/07/" target="_blank">
                
                MySQL · 捉虫动态 · Relay log 中 GTID group 完整性检测
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/08/" target="_blank">
                
                MySQL · 答疑释惑 · UPDATE交换列单表和多表的区别
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/09/" target="_blank">
                
                MySQL · 捉虫动态 · 删被引用索引导致crash
              </a>
            </li>
          
      
          
          

          
            
              <li>
            
              <a href="/monthly/2015/04/10/" target="_blank">
                
                MySQL · 答疑释惑 · GTID下auto_position=0时数据不一致
              </a>
            </li>
          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
          
          

          
      
    </ul>
  </li>
</ul>
</nav>

    <div class="title">
      <h2>
        
        MySQL · 捉虫动态 · 连接断开导致XA事务丢失
      </h2>
    </div>
  </div>
  <div class="content typo">
    <section class="post">
      <p>我们看到在MySQL 5.7版本里大量遗留很多年的bug都被fix掉了，bug#12161就是其中一个，该bug在2005年第一次report到Bug list上，十年之后终于在MySQL 5.7.7 第一个RC版本被fix了。</p>

<h2>Bug描述</h2>

<p>当我们显式开启一个XA事务，执行操作，并完成XA PREPARE后，如果Kill session或者主动断开再重连执行XA RECOVER，之前的这个XA事务就会直接丢失掉了。</p>

<p>例如：</p>

<pre><code>mysql&gt; XA BEGIN 'abc';
Query OK, 0 rows affected (0.00 sec)
   
mysql&gt; INSERT INTO t1 VALUES (1,2,3);
Query OK, 1 row affected (0.00 sec)
   
mysql&gt; XA END 'abc';
Query OK, 0 rows affected (0.00 sec)
   
mysql&gt; XA PREPARE 'abc';
Query OK, 0 rows affected (0.00 sec)
   
mysql&gt; Ctrl-C -- exit!
Aborted
   
mysql&gt; XA RECOVER;
Empty set (0.00 sec)
</code></pre>

<p>有趣的是，如果在XA PREPARE后把实例KILL掉，是可以通过XA RECOVER恢复的：</p>

<pre><code>mysql&gt; XA RECOVER;
+----------+--------------+--------------+------+
| formatID | gtrid_length | bqual_length | data |
+----------+--------------+--------------+------+
| 1 | 3 | 0 | abc |
+----------+--------------+--------------+------+
1 row in set (0.00 sec)
   
mysql&gt; XA COMMIT 'abc';
Query OK, 0 rows affected (0.00 sec)
</code></pre>

<p>虽然实例异常重启可以恢复事务，但引入的另外一个问题是：事务变更的binlog丢失，导致主备数据不一致。</p>

<p>bug产生的原因也很简单：在退出session时，线程总是会去无条件的回滚掉自己尚未提交的事务。</p>

<h2>官方修复</h2>

<h3>持久化</h3>
<p>为了解决这个问题，将XA的两阶段记录到了Binlog中；</p>

<p>对于上文描述的序列，当执行到XA PREPARE时，记录第一阶段的binlog，如下：</p>

<pre><code>Query event : XA START X'616263',X'’,1  // 这里的'616262'即是'abc'的十六进制编码
Table_map event
Write_rows event
Query event：XA END X'616263',X'',1
XA_prepare event： XA PREPARE X'616263',X'’,1
</code></pre>

<p>这时候该XA事务同时在InnoDB层（事务处于Prepare状态，Redo持久化到磁盘）和Server层都有持久化信息。</p>

<p>其中XA_PREPARE事件是新引入的事件类型（内部类为XA_prepare_event），以后版本升级需要注意到这个低版本不兼容事件。</p>

<p>然后再执行XA COMMIT ‘abc’，产生新的事件：</p>

<pre><code>Query event：XA COMMIT X'616263',X'',1
</code></pre>

<p>如果执行XA ROLLBACK，则记录：</p>

<pre><code>Query event：XA ROLLBACK X'616263',X'',1
</code></pre>

<p>由于XA PREPARE和XA COMMIT是分开执行的，因此在这两个事件中间可能存在别的事务，备库复制线程需要处理这种情况。</p>

<p>为了实现XA PREPARE写binlog，对binlog_prepare进行了扩展，这里会调用mysql_bin_log.commit， 将cache中的binlog刷到文件中。</p>

<p>Tips：XID可以包含三个部分：gtrid, [, bqual [, format ID]]，其中gtrid是必选的，表示全局标识，bqual是分支标识，默认为空’‘，format ID是一个unsigned整型，默认值为1，在上例中，我们只指定了gtrid为’abc’，因此bqual段和format ID均为默认值。更具体的描述参考<a href="http://dev.mysql.com/doc/refman/5.7/en/xa-statements.html">官方文档</a>。</p>

<h3>如何恢复</h3>

<p>当会话断开时（例如kill session或者一次干净的shutdown/restart操作），我们必须要能恢复该事务，之前的逻辑是在cleanup时，直接回滚所有的活跃事务。在新版本中，对XA PREPARE的事务做了特殊处理（THD::cleanup），如果处于Prepare状态，就将事务的in_recovery设置为TRUE，并更新到hash表transaction_cache中（transaction_cache_detach），该hash表用于维护所有XA事务。</p>

<p>对于非XA的活跃事务，在会话断开时，依然采用回滚策略。</p>

<p>当重连客户端后，我们可以直接执行 XA COMMIT ‘abc’，这时候会通过XID关键字去搜索transaction_cache并将对应的事务提交掉。</p>

<p>同时BINLOG的状态要保持一致，如果会话断开前的XA PREPARE没有记录Binlog， 重连后执行XA COMMIT也不应该记录。</p>

<h3>备库复制</h3>

<p>由于XA PREPARE和XA COMMIT是分开记录的，当碰到XA COMMIT时，备库采用等待之前的事务全部完成，然后再执行的方式（相当于退化到串行）。</p>

<p>另外，我们知道在一个正常的会话过程中，总是为其cache一个事务对象，新的事务会重用这个事务对象，避免多次分配；而XA事务的COMMIT和PREPARE是分离的，需要为XA事务单独分配事务对象。因此复制线程执行XA START时，将其拥有的事务对象临时保存起来（detach_native_trx），当执行到XA_prepare_log_event事件时，再将其恢复给复制线程，同时XA事务对象关闭read view，将is_recovered设置为TRUE（函数innodb_replace_trx_in_thd）。</p>

<p>随后复制线程在执行到XA COMMIT时直接根据XID找到对应的XA事务进行提交。</p>

<h2>参考：</h2>
<p><a href="http://dev.mysql.com/worklog/task/?id=6860">WL#6860</a> Binlogging XA-prepared transaction<br />
Github：git show f4c37f7aea732763947980600c6882ec908a54a0<br />
MySQL 5.7.7-RC</p>


    </section>
  </div>
</div>


    <footer>
  <a href="http://mysql.taobao.org/" target="_blank" class="muted">阿里云RDS-数据库内核组</a>
  <br>
  <a href="https://github.com/alibaba/AliSQL" target="_blank" class="muted">欢迎在github上star AliSQL</a>
</br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 未本地化版本许可协议</a>进行许可。
</footer>

<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      if( $(this).scrollTop() > offset_opacity ) {
        $back_to_top.addClass('cd-fade-out');
      }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>



    <a href="#0" class="cd-top"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="10px"
   width="38px" height="60px" viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
      <polygon fill="#FFFFFF" points="8,2.8 16,10.7 13.6,13.1 8.1,7.6 2.5,13.2 0,10.7 "/>
    </svg>
    </a>
  </body>

</html>
